# ADR Передача ставок в кол-центр

### **Название задачи:**
Передача актуальных ставок в кол-центр и партнёрский кол-центр  
### **Автор:**
Киселев Олег
### **Дата:**  
21.09.2025  

---

### Функциональные требования

|**№**| **Действующие лица или системы**                            |**Use Case**| **Описание**                                                                                                                                                   |
| :-: |:------------------------------------------------------------| :- |:---------------------------------------------------------------------------------------------------------------------------------------------------------------|
|1| Сотрудник кол-центра, Система кол-центра                    |Получить актуальные ставки| Оператор открывает карточку клиента и видит список актуальных депозитных ставок, подтянутых из центрального хранилища (Rate Service).                          |
|2| Сотрудник партнёрского кол-центра, Внешняя система партнёра |Получить актуальные ставки (файл)| Сотрудник партнёрского кол-центра получает ежедневно выгруженный файл с актуальными ставками, подготовленный банком и переданный через безопасный канал (SFTP).|
|3| Rate Service, Integration Layer                             |Экспорт ставок для партнёрского кол-центра| Система формирует ежедневный выгрузочный файл (CSV/XML), передаёт его по SFTP во внешнюю систему партнёра.                                                     |
|4| Rate Service, Система кол-центра                            |API-доступ к ставкам| Система кол-центра делает вызов API Rate Service для отображения актуальных ставок операторам в реальном времени.                                              |

### Нефункциональные требования

|**№**| **Требование**                                                                                      |
|:---:|:----------------------------------------------------------------------------------------------------|
|  1  | Доступность ставок для кол-центра не ниже 99.9%.                                                    |
|  2  | Актуализация ставок не реже одного раза в день                                                      |
|  3  | Передача файлов партнёру через защищённый канал (SFTP), API для кол-центра через TLS и авторизацию. |
|  4  | Возможность подключения новых партнёрских кол-центров без изменения основной архитектуры.           |
|  5  | Хранение ставок в Rate Service с API для интеграции.                                                |
|  6  | Мониторинг успешности экспорта и доставки файлов партнёру, оповещения в случае сбоя.                |
|  7  | Защита персональных данных клиентов при формировании выгрузок                                       |

---

## Решение

#### Логика
- Централизованный сервис ставок (Rate Service), созданный в рамках MVP, становится единственным источником правды.  
- Для внутреннего кол-центра используется онлайн-доступ через API (низкая задержка, всегда актуальные данные).  
- Для партнёрского кол-центра используется файловый обмен по SFTP, так как их система не поддерживает API.  
- Экспорт файлов автоматизируется (ежедневная выгрузка, мониторинг доставки).  

#### С4 Context

```plantuml
@startuml Context
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

Person(call_center_operator, "Оператор кол-центра", "Консультирует клиентов")
Person(partner_call_center_operator, "Оператор партнёрского кол-центра", "Консультирует клиентов (внешняя система)")

System(rate_service, "Rate Service", "Централизованный сервис ставок")
System(call_center_system, "Система кол-центра", "Java Spring Boot + React + PostgreSQL")
System_Ext(partner_call_center_system, "Система партнёрского кол-центра", "Внешняя, только файловый импорт")

Rel(call_center_operator, call_center_system, "Просматривает ставки в карточке клиента")
Rel(call_center_system, rate_service, "Запрашивает актуальные ставки (REST API, TLS)")
Rel(rate_service, partner_call_center_system, "Выгружает актуальный файл по расписанию (SFTP)")
Rel(partner_call_center_operator, partner_call_center_system, "Просматривает ставки из файла")

@enduml
```

#### С4 Container

```plantuml
@startuml Container
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

System_Boundary(rateB, "Rate Service") {
  Container(rate_api, "Rate API", "Java Spring Boot", "REST API, предоставляет ставки в реальном времени")
  ContainerDb(rate_db, "Rate DB", "Oracle", "Хранение ставок, заменяет Excel")
  Container(exporter, "Rate Exporter", "Batch Job", "Формирует CSV/XML файл и передаёт через SFTP партнёру")
}

System(call_center_system, "Система кол-центра", "React + Spring Boot + PostgreSQL")
System(partner_call_center_system, "Система партнёрского кол-центра", "Внешняя, только файловый импорт")

Person(call_center_operator, "Оператор кол-центра")
Person(partner_call_center_operator, "Оператор партнёрского кол-центра")

Rel(call_center_operator, call_center_system, "Просматривает ставки")
Rel(call_center_system, rate_api, "GET /rates (TLS, авторизация)")
Rel(rate_api, rate_db, "CRUD ставки")
Rel(exporter, rate_db, "Читает актуальные ставки")
Rel(exporter, partner_call_center_system, "Передаёт файл по SFTP")
Rel(partner_call_center_operator, partner_call_center_system, "Смотрит ставки из файла")

@enduml
```

### Альтернативы

1. Отправка ставок партнёру по e-mail

Достоинства: проще реализовать  
Недостатки: небезопасно, риск задержек и ошибок

2. Организация VPN и API-доступа для партнёра  

Достоинства: единый способ интеграции (API)  
Недостатки: дорого, долго и небезопасно (партнёр не готов поддерживать API)  

3. Синхронизация ставок через ручные XLS-файлы

Достоинства: соответствует старой привычной практике  
Недостатки: неудобно, риск ошибок, нет автоматизации

### Недостатки, ограничения, риски

- Для партнёрского кол-центра возможна задержка до 24 часов между обновлениями ставок  
- Поддержка двух каналов (API + SFTP) усложняет сопровождение  
- Rate Service должен быть высокодоступным, иначе пострадает кол-центр  
- Сбой в выгрузке или доставке файлов будет означать, что партнёрский кол-центр работает с устаревшими ставками  
- Перегрузка кол-центра из-за маркетинговых кампаний, даже с актуальными ставками  
- Риск утечки файла ставок (надо шифровать при передаче и хранении)  
